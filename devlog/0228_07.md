# 0228_07 — 全仓库深度重构

**Status:** Done  
**Owner:** AI_Omega  
**Scope:** 全仓库 (src/, index.html, package.json, Cargo.toml, lib.rs, capabilities/default.json)

---

## 变更概览

### Phase 1: 死代码 + 依赖清理
- 删除 `src/assets/react.svg`
- `index.html`: `lang="zh-CN"`, 移除死 vite.svg icon link, title → "ZenReply"
- `package.json`: 移除 `@tauri-apps/plugin-opener`, `autoprefixer`, `postcss`
- `Cargo.toml`: 移除 `tauri-plugin-opener`
- `lib.rs`: 移除 `.plugin(tauri_plugin_opener::init())`
- `capabilities/default.json`: 移除 `"opener:default"`
- `useZenReplyFlow.ts`: `SettingsDeps` 从 export 降级为 local type

### Phase 2: 设计令牌 + 共享组件
- **新增** `src/shared/tokens.ts` — 所有视觉常量 (窗口尺寸、阴影、翻转关键帧、halo)
- **新增** `src/shared/motion.ts` — 所有 framer-motion transition/spring 预设
- **新增** `src/components/shared/GlassCard.tsx` — 双层磨砂卡片壳，消除 WorkArea/SettingsPanel 重复 CSS
- `index.css`: body color `#f2f5f9` → `#f4f4f5` (zinc-100); `will-change` 改为动态 class toggle
- `types.ts` → 纯类型定义; 运行时常量迁移到 `constants.ts`

### Phase 3: Context 架构
- **新增** `src/contexts/ToastContext.tsx`
- **新增** `src/contexts/SettingsContext.tsx`
- **新增** `src/contexts/ZenReplyContext.tsx`
- **新增** `src/contexts/AppProvider.tsx` — 层级组合 Toast → Settings → ZenReply
- **新增** `src/AppShortcuts.tsx` — 键盘快捷键逻辑独立组件
- **重写** `App.tsx`: 195 行 → 45 行, 零 prop drilling
- **重写** 全部 6 个 UI 组件: WorkArea, SettingsPanel, SourceTextCard, ResultCard, RoleComposer, ZenToast
  - 全部移除 prop 透传, 改从 Context 消费状态
  - 统一 `active:scale-[0.97]`
  - 统一 motion presets 引用

### Phase 4: Tailwind v4 规范化
- 全部 `rounded-[24px]` → `rounded-3xl`
- 全部 `rounded-[16px]` → `rounded-2xl`
- 全部 `rounded-[12px]` → `rounded-xl`
- 全部 `bg-white/[0.0x]` → `bg-white/x`
- 全部 `bg-gradient-to-r` → `bg-linear-to-r`
- `z-[9999]` → `z-9999`
- `h-[1px]` → `h-px`, `min-h-[5rem]` → `min-h-20`, `min-h-[3rem]` → `min-h-12`
- label 无障碍: 添加 `htmlFor` + `id` 关联

### Phase 5: 窗口生命周期优化
- `useAutoResizeWindow`: show/setFocus 从每次 resize 分离, 仅首次 report 时调用
- 新增 16ms ResizeObserver 防抖, 防止高频 IPC
- 新增 `resetVisibility()` 方法, FlipCard 在新 session 时重置
- 空 catch → `console.warn` 错误日志

### Phase 6: 异步模式修复
- `useZenReplyFlow` 事件监听器: `.then()` 链 → `async/await` + `Promise.all` + `.catch()`
- `confirmCustomRole`: `void startGenerating()` → `.catch(() => {})`

### Phase 7: Rust 线程优化
- `on_shortcut_pressed`: 整个函数体移入 `std::thread::spawn`, 释放 Tauri 主事件循环
- 原来 `quick_capture()` 的 80ms `thread::sleep` 不再阻塞 UI 线程
- `update_tray_menu` 在 spawn 前立即执行

---

## 构建验证
- `npx -p typescript tsc --noEmit` ✅ 零错误
- `bun run build` (tsc + vite) ✅ 成功
- `cargo check` ✅ 成功
