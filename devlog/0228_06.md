# 0228_06: 翻转动画修复 — 初始翻转 + 翻转时底部裁剪

## 问题现状

**Bug A — 首次打开时多余翻转**
打开主面板时 card 会播放一次 BACKWARD_ROTATE 关键帧动画（180° → 0°），产生不必要的翻转效果。

**Bug B — 翻转到设置页时底部裁剪**
从 WorkArea 翻转到 SettingsPanel 时，窗口底部被裁剪，WorkArea 面板在旋转过程中显示不完整。

## 底层原因分析

**Bug A — 根因：framer-motion 关键帧数组在 mount 时始终播放**
`motion.div` 的 `animate={{ rotateY: BACKWARD_ROTATE }}` 中 BACKWARD_ROTATE 是关键帧数组 `[180, 183, 90, ..., 0]`。即使设置了 `initial={false}`，framer-motion 对关键帧数组会从第一个值播放到最后一个值。因此 mount 时卡片从 180° 翻转到 0°。

**Bug B — 根因：React 批量状态更新导致 ResizeObserver 与窗口扩展竞态**
翻转触发的 `useLayoutEffect` 中调用了：
1. `setIsFlipAnimating(true)` — 被 React 批量处理，不会立即生效
2. `onContentHeightChange(maxH + FLIP_WINDOW_EXTRA)` — 调用 Tauri 的 `setSize()` 扩展窗口

但第二个 `useLayoutEffect`（ResizeObserver）在同一渲染周期内执行时，`isFlipAnimating` 仍为 `false`（因为批量更新未生效）。Observer 因此调用 `onContentHeightChange(当前面高度)` 覆盖了扩展后的窗口尺寸，导致窗口缩小。

同时 Tauri v2 的 `Window.setSize()` 是异步 IPC（返回 `Promise<void>`），存在 ~5-10ms 的延迟。如果 Observer 在 IPC 完成前发起竞争调用，会进一步加剧裁剪。

## 预期的改动点

文件：`src/components/layout/FlipCard.tsx`

1. **新增 `isFlipAnimatingRef`（ref）**：与 `isFlipAnimating` state 并行，在翻转触发时同步设为 true。Observer 检查 ref（立即生效）而非 state（批量延迟）。
2. **新增 `hasFlippedThisSession` ref**：追踪当前会话是否发生过翻转。当 `panelAnimateKey` 改变（新会话）时重置。
3. **重置 `prevFlippedRef`**：当 `panelAnimateKey` 改变时同步到当前 `isFlipped` 值，避免新会话的首帧被误判为翻转。
4. **条件化 animate 关键帧**：`hasFlippedThisSession=false` 时使用单值（`rotateY: 0`, `scale: 1`）不播放动画；`=true` 时使用关键帧数组执行翻转。
5. **handleFlipComplete 中同步清除 ref**：翻转结束后 `isFlipAnimatingRef.current = false`。
## 实施结果

已完成所有修改，TypeScript 编译通过（零错误）。

### 具体改动（FlipCard.tsx，33 行净增）

| 改动 | 说明 |
|------|------|
| `isFlipAnimatingRef` | 同步 ref，翻转触发时立即设为 true，ResizeObserver 的 `measure()` 回调首先检查此 ref，阻止竞态覆盖 |
| `hasEverFlipped` | 会话级 ref，仅在用户实际触发翻转后才启用关键帧数组动画 |
| `prevPanelKeyRef` + 渲染期重置 | `panelAnimateKey` 改变时重置 `hasEverFlipped`/`prevFlippedRef`/`flipCountRef`/`isFlipAnimatingRef` |
| `animateRotateY` / `animateScale` / `animateShadow` | 首次挂载前使用单值（0 / 1 / 静态阴影），翻转后切换为关键帧数组 |
| `measure()` 内 ref 守卫 | `if (isFlipAnimatingRef.current) return;` 防止 React 批量提交延迟期间 Observer 缩小窗口 |