# 0228_03 — 翻转动画优化 & Toast 居中修复

**日期**: 2026-02-28  
**Owner**: AI_Gamma  
**状态**: Research

---

## 问题现状

### 1. 翻转动画不协调
当前 `FlipCard.tsx` 的翻转使用 Framer Motion spring 动画：
```tsx
rotateY: { type: "spring", stiffness: 70, damping: 16 }
```
**问题表现**：
- **弹簧阻尼不足** — `stiffness: 70 / damping: 16` 的组合过于松弛，翻转过程中回弹幅度过大（约 ±8°），视觉上像"摇晃"而非"翻转"
- **没有内容过渡** — 正/背面内容在翻转的同时硬切，当卡片处于 90° 侧面（backface 切换瞬间）时，内容突兀地闪现
- **高度过渡与旋转不同步** — 高度使用独立的 spring 参数（`stiffness: 170, damping: 24`），与旋转的 spring 节奏不一致，导致翻转到一半时容器高度突然跳变
- **缺少视觉反馈** — 翻转是一个纯几何变换，没有光影、阴影、模糊等辅助效果暗示 3D 深度

### 2. Toast 消息不能始终居中
当前 `ZenToast.tsx` 使用以下定位：
```tsx
className="pointer-events-none absolute inset-0 z-40 flex items-center justify-center"
```
**问题表现**：
- 使用 `absolute inset-0` 相对于最近定位祖先，而非视口
- 在 `App.tsx` 中 `ZenToast` 与 `FlipCard` 是同级兄弟，外层无 `relative` 容器时退化为相对 `<body>`，但翻转动画期间 preserve-3d 上下文会影响层叠和定位
- 当窗口高度随内容自适应变化（`useAutoResizeWindow`）时，toast 跟随容器高度变化而偏移
- 翻转 180° 后 toast 可能被 backface-visibility:hidden 的面遮盖

---

## 底层原因分析

### 翻转不协调的根因
1. **单一 spring 曲线** — 真实的卡片翻转需要分阶段：前半程加速 → 90° 过渡 → 后半程减速。单一 spring 无法精细控制
2. **无 opacity 联动** — 前面/背面切换时没有配合 opacity 渐变来掩盖 backface 切换瞬间的闪烁
3. **height 独立动画** — height 的 spring 参数跟 rotateY 的 spring 参数使用了不同的刚度/阻尼组合
4. **高度取 max 策略导致空白** — `flipHeight = Math.max(fh, bh)` 使较矮面底部出现大片空白；而高度 spring (`stiffness:170/damping:24`) 与旋转 spring (`stiffness:70/damping:16`) 到达终点时间不同，翻转过程中容器高度"先到"造成跳变；翻转完成后停留在 max 高度而非目标面精确高度

### Toast 不居中的根因
1. **定位方式错误** — `absolute` 只在最近 positioned ancestor 内居中，不能保证相对视口居中
2. **3D 变换干扰** — `preserve-3d` + `perspective` 上下文中使用 `absolute` 定位，变换矩阵会波及子元素定位计算

---

## 改进方案

### 方案总览

将翻转动画从"简单 spring 旋转"升级为**五阶段编排式翻转**，配合光晕、模糊、阴影、内容淡入淡出，创造出电影级的 3D 翻转体验。高度管理采用**"先翻后调"策略** — 翻转期间锁定最大高度，翻转完成后再平滑过渡到目标面精确高度，彻底消除翻转中的高度跳变。同时将 Toast 改为 `fixed` 视口居中定位。

### A. 高度差异处理 — "先翻后调"策略 (Flip → Settle → Resize)

#### 问题本质

当前 `flipHeight = Math.max(frontH, backH)`，始终取两面最大值。这意味着：
- **翻到较矮面时**：底部出现大片空白，内容"悬浮"在容器上方
- **高度 spring 与旋转 spring 不同步**：高度用 `stiffness: 170, damping: 24`，旋转用 `stiffness: 70, damping: 16`，两者到达终点的时间不同，导致翻转过程中容器高度"先到"或"后到"
- **90° 侧面时高度变化最刺眼**：卡片呈一条线时如果高度也在抖动，视觉极其混乱

#### 解决策略：三阶段高度管理

```
翻转前          翻转中 (0-720ms)        翻转后 (720ms+)
┌─────────┐    ┌─────────────────┐    ┌──────────────┐
│ 当前面高度│ →  │ max(前面, 背面)   │ →  │ 目标面精确高度 │
│ (精确)   │    │ (锁定，不变)     │    │ (平滑过渡)    │
└─────────┘    └─────────────────┘    └──────────────┘
```

**Phase A**: 翻转触发瞬间 → 高度立即跳到 `max(frontH, backH)`，确保翻转过程中两面内容都不溢出

**Phase B**: 整个翻转动画期间（720ms） → 高度**完全锁定**，不参与动画。翻转是纯旋转+视觉效果，高度纹丝不动

**Phase C**: 翻转动画结束后 → 延迟 50ms，高度从 `max` 平滑过渡到目标面的精确高度（duration: 300ms, ease-out）

#### 实现要点

```tsx
// FlipCard.tsx — 高度管理状态
const [isFlipAnimating, setIsFlipAnimating] = useState(false);
const [targetHeight, setTargetHeight] = useState(minHeight);
const prevFlippedRef = useRef(isFlipped);

// 检测翻转触发
useLayoutEffect(() => {
  if (isFlipped !== prevFlippedRef.current) {
    prevFlippedRef.current = isFlipped;
    setIsFlipAnimating(true);

    // Phase A: 锁定到 max 高度
    const fh = frontRef.current?.offsetHeight ?? 0;
    const bh = backRef.current?.offsetHeight ?? 0;
    setTargetHeight(Math.max(fh, bh));
  }
}, [isFlipped]);

// 翻转动画完成回调
const handleFlipComplete = useCallback(() => {
  setIsFlipAnimating(false);

  // Phase C: 延迟后调整到目标面精确高度
  requestAnimationFrame(() => {
    const exactH = isFlipped
      ? (backRef.current?.offsetHeight ?? 0)
      : (frontRef.current?.offsetHeight ?? 0);
    if (exactH > 0) {
      setTargetHeight(exactH);
      onContentHeightChange?.(exactH);
    }
  });
}, [isFlipped, onContentHeightChange]);

// 动画配置
<motion.div
  animate={{
    rotateY: isFlipped ? 180 : 0,
    height: targetHeight,
  }}
  transition={{
    rotateY: { /* keyframes 编排，见下方 */ },
    height: isFlipAnimating
      ? { duration: 0 }                              // Phase B: 翻转中高度立即跳变，不动画
      : { duration: 0.3, ease: [0.22, 1, 0.36, 1] }, // Phase C: 翻转后平滑过渡
  }}
  onAnimationComplete={handleFlipComplete}
>
```

#### 窗口高度联动

`useAutoResizeWindow` 的 `reportContentHeight` 也需配合：
- **翻转中**: 报告 max 高度（确保窗口足够大，不裁剪）
- **翻转后**: 报告精确高度（窗口收缩到刚好）

```tsx
// Phase A 时
onContentHeightChange?.(Math.max(fh, bh));

// Phase C 时（handleFlipComplete 内）
onContentHeightChange?.(exactH);
```

这样窗口高度变化始终跟在翻转之后，用户看到的是：翻转 → 落定 → 窗口跟随收缩，而非翻转和收缩同时发生。

---

### B. 翻转动画重构 — 五阶段编排

Phase 1 → Phase 2 → Phase 3 → Phase 4 → Phase 5

| 阶段 | 时间 | rotateY | 关键效果 |
|---|---|---|---|
| **Phase 1: 蓄力** | 0 – 80ms | 0° → -3° | 卡片微微向反方向倾斜（蓄力感），正面内容开始淡出 |
| **Phase 2: 快速翻转前半** | 80 – 280ms | -3° → 90° | 主翻转加速阶段，动态光晕从左侧掠入，阴影扩散 |
| **Phase 3: 过渡瞬间** | 280 – 320ms | 90° → 90° | 卡片侧面停留 40ms（视觉暂停），叠加高斯模糊 + 光晕最亮 |
| **Phase 4: 快速翻转后半** | 320 – 520ms | 90° → 180° | 翻转完成，光晕从右侧掠出，背面内容开始淡入 |
| **Phase 5: 余震** | 520 – 720ms | 180° → 183° → 179° → 180° | 2-3 次微弱抖动（衰减振荡），传递"落定"的物理感 |

**实现方式**: 使用 Framer Motion 的 `keyframes` + `times` 而非单一 `spring`：

```tsx
// FlipCard.tsx — 核心动画配置
const flipForwardKeyframes = {
  rotateY: [0, -3, 90, 90, 180, 183, 179, 180],
  // times:  [0, 0.11, 0.39, 0.44, 0.72, 0.80, 0.90, 1.0]
};

const flipBackwardKeyframes = {
  rotateY: [180, 183, 90, 90, 0, -3, 2, 0],
};

const flipTransition = {
  rotateY: {
    duration: 0.72,
    times: [0, 0.11, 0.39, 0.44, 0.72, 0.80, 0.90, 1.0],
    ease: [
      [0.32, 0, 0.67, 0],    // Phase 1: ease-in (蓄力)
      [0.25, 0.1, 0.25, 1],  // Phase 2: ease-out (加速翻转)
      [0.5, 0, 0.5, 1],      // Phase 3: linear (暂停)
      [0.25, 0.1, 0.25, 1],  // Phase 4: ease-out (完成翻转)
      [0.33, 1, 0.68, 1],    // Phase 5a: ease-out (余震)
      [0.33, 1, 0.68, 1],    // Phase 5b
      [0.33, 1, 0.68, 1],    // Phase 5c: settle
    ],
  },
  height: {
    duration: 0.72,
    ease: [0.22, 1, 0.36, 1], // 与旋转同步、统一时长
  },
};
```

### B. 动态光晕掠过 (Halo Sweep)

在翻转容器上叠加一个 `::after` 伪元素 / 独立 `<div>`，使用渐变 + `translateX` 动画模拟光线从一侧扫过的效果。

**实现思路**：
```tsx
// 在 FlipCard 的旋转容器内添加一个光晕层
<motion.div
  className="pointer-events-none absolute inset-0 z-10 overflow-hidden rounded-[24px]"
  initial={{ opacity: 0 }}
  animate={{
    opacity: isFlipped !== wasFlipped ? [0, 0.6, 0.8, 0.3, 0] : 0,
  }}
  transition={{ duration: 0.72, times: [0, 0.3, 0.44, 0.7, 1] }}
>
  <motion.div
    className="absolute inset-y-0 w-[120%] bg-gradient-to-r from-transparent via-white/20 to-transparent"
    animate={{
      x: isFlipped !== wasFlipped ? ["-120%", "120%"] : "-120%",
    }}
    transition={{ duration: 0.72, ease: "easeInOut" }}
  />
</motion.div>
```

**视觉效果**：翻转时一道半透明白色光带从左向右扫过卡片表面，在 90° 过渡瞬间最亮，翻转完成后消散。

### C. 内容淡出 / 淡入延迟 (Content Crossfade)

正面和背面内容不再跟随旋转硬切，而是：
- **正面**: 翻转开始时 opacity 从 1 → 0（持续 ~180ms，翻转前半段完成前消失）
- **背面**: 翻转后半段 opacity 从 0 → 1（延迟 ~360ms 开始，持续 ~200ms）

```tsx
{/* Front face */}
<motion.div
  ref={frontRef}
  className="zen-flip-face absolute inset-x-0 top-0 w-full"
  style={{ pointerEvents: isFlipped ? "none" : "auto" }}
  animate={{ opacity: isFlipped ? 0 : 1 }}
  transition={{
    opacity: {
      duration: 0.18,
      delay: isFlipped ? 0 : 0.36,  // 翻过去时立即淡出，翻回来时延迟淡入
      ease: "easeOut",
    },
  }}
>
  {front}
</motion.div>

{/* Back face */}
<motion.div
  ref={backRef}
  className="zen-flip-face absolute inset-x-0 top-0 w-full"
  style={{
    transform: "rotateY(180deg)",
    pointerEvents: isFlipped ? "auto" : "none",
  }}
  animate={{ opacity: isFlipped ? 1 : 0 }}
  transition={{
    opacity: {
      duration: 0.20,
      delay: isFlipped ? 0.36 : 0,  // 翻过去时延迟淡入，翻回来时立即淡出
      ease: "easeOut",
    },
  }}
>
  {back}
</motion.div>
```

### D. 翻转后的余震 (Post-flip Aftershock)

除了 rotateY 本身的 183° → 179° → 180° 微震外，还叠加一个 `scale` 脉冲：

```tsx
// 翻转动画中 scale 的变化
const flipKeyframes = {
  rotateY: [0, -3, 90, 90, 180, 183, 179, 180],
  scale:   [1, 1, 0.97, 0.97, 1, 1.008, 0.998, 1],
};
```

**效果**: 翻转过程中卡片微微缩小 3%（暗示深度），翻转完成后有 0.8% 的放大脉冲，最终回归原始大小。这模拟了卡片"落在桌面上"的微弹感。

### E. 动态阴影联动 (Shadow Depth Cue)

翻转过程中 boxShadow 同步变化，增强 3D 纵深感：

```tsx
const shadowKeyframes = {
  boxShadow: [
    "0 20px 70px rgba(0,0,0,0.3)",   // 初始
    "0 25px 90px rgba(0,0,0,0.45)",   // 蓄力抬起
    "0 35px 120px rgba(0,0,0,0.6)",   // 90° 最高点
    "0 35px 120px rgba(0,0,0,0.6)",   // 暂停
    "0 20px 70px rgba(0,0,0,0.3)",    // 落回
    "0 18px 65px rgba(0,0,0,0.28)",   // 余震
    "0 21px 72px rgba(0,0,0,0.32)",
    "0 20px 70px rgba(0,0,0,0.3)",    // 稳定
  ],
};
```

### F. Toast 居中修复

**核心修改**: 将 Toast 从 `absolute inset-0` 改为 `fixed inset-0`，使其始终相对视口居中，不受翻转动画和窗口高度变化的影响。

```tsx
// ZenToast.tsx
<motion.div
  key={`zen-toast-${toast.variant}-${toast.message}`}
  initial={{ y: 10, opacity: 0, scale: 0.92 }}
  animate={{ y: 0, opacity: 1, scale: 1 }}
  exit={{ y: -8, opacity: 0, scale: 0.95 }}
  transition={{
    y: { type: "spring", stiffness: 380, damping: 24 },
    opacity: { duration: 0.18 },
    scale: { type: "spring", stiffness: 400, damping: 22 },
  }}
  className="pointer-events-none fixed inset-0 z-[9999] flex items-center justify-center"
  //                              ^^^^^ 改 absolute → fixed
  //                                     ^^^^^^^^ 提升 z-index 确保在 preserve-3d 之上
>
  <ToastContent toast={toast} />
</motion.div>
```

**同时调整 App.tsx 渲染顺序**: 将 `<ZenToast>` 移到与 FlipCard 完全独立的层，避免 3D 变换上下文污染。

---

## 预期的改动点

| 文件 | 改动内容 |
|---|---|
| `src/components/layout/FlipCard.tsx` | 翻转动画改为 keyframes 编排；**高度三阶段管理（锁定→解锁→平滑过渡）+ onAnimationComplete 回调**；添加光晕层；前/背面 opacity 联动；scale 脉冲；shadow 联动 |
| `src/components/feedback/ZenToast.tsx` | `absolute` → `fixed`；提升 z-index；优化入场/退场动画参数 |
| `src/index.css` | 添加光晕渐变 CSS（如需）、翻转过渡模糊 CSS |
| `src/App.tsx` | 调整 ZenToast 渲染位置确保脱离 3D 上下文（可能无需改动，当前已是同级） |

### Scope（文件锁定范围）
- `src/components/layout/FlipCard.tsx`
- `src/components/feedback/ZenToast.tsx`
- `src/index.css`

> **注意**: `FlipCard.tsx` 与 0228_01 任务有冲突（0228_01 锁定了 FlipCard.tsx）。需等待 0228_01 完成或协调后方可实施。

---

## 动画时间轴可视化

```
时间(ms)  0    80   280  320  520  600  660  720  770  1070
          │────│─────│────│─────│────│────│────│────│─────│
rotateY   0  -3°   90°  90° 180° 183° 179° 180°
          ├蓄力─┤快翻前半┤暂停┤快翻后半┤──余震──────┤
scale     1    1  0.97 0.97   1  1.008 0.998  1
          ├────┤──收缩──┤────┤──展开──┤──脉冲──────┤
光晕       0   0  0.6  0.8  0.3    0    0     0
          ├────┤─渐亮──┤最亮┤──渐灭────────────────┤
前面α     1    1  0.3    0    0    0    0     0
          ├────┤─淡出──┤消失┤
背面α     0    0    0    0  0.2  0.7   1     1
          │              ├─延迟──┤──淡入──┤
阴影深度   ■■  ■■■  ■■■■■ ■■■■■ ■■   ■■   ■■   ■■
          ├────┤──加深──┤最深┤──回落──┤──微震──────┤
高度      当前面H ─── max(前H,后H) 锁定不变 ──────── │等50ms│─ 目标面精确H ─│
          ├─瞬间跳到max────────────────────────────┤      ├── 300ms ease ─┤
窗口      当前大小 ─── 跟随max ──────────────────── │      │─ 跟随精确H ───│
```

**高度变化时序说明**：
- `0ms` — 翻转触发，高度立即设为 `max(frontH, backH)`，确保两面都不溢出
- `0~720ms` — 翻转全程高度**完全锁定**，不参与任何动画
- `770ms` — 翻转落定 50ms 后，高度开始从 max 平滑过渡到目标面精确高度 (300ms ease-out)
- `1070ms` — 高度过渡完成，窗口大小跟随稳定

---

## 潜在风险

1. **性能** — keyframes 动画 + boxShadow 动画可能在低端设备上掉帧。可通过 `will-change: transform, opacity` 和 GPU 合成层缓解。Shadow 动画可降级为仅变化 opacity 而非 boxShadow 属性
2. **Framer Motion 兼容性** — keyframes 中的自定义 `ease` 数组需要 FM v10+。当前项目使用 FM，需确认版本
3. **文件冲突** — `FlipCard.tsx` 被 0228_01 锁定中，实施前需协调
4. **Toast fixed 定位** — 在 Tauri 透明窗口中 `fixed` 定位是相对于 webview 视口，应当工作正常。但需验证 `preserve-3d` 是否会影响 `fixed` 子元素的层叠上下文（已通过将 Toast 渲染在 3D 容器外部规避）

---

## 实际改动记录

### FlipCard.tsx — 完全重构翻转动画
1. **五阶段 keyframes 编排** — `rotateY` 从 spring 改为 8 帧 keyframes（蓄力→快翻→暂停→完成→余震），使用 `as const` 元组 ease 曲线
2. **"先翻后调"高度管理** — 翻转触发时锁定 `max(frontH, backH)`；翻转中 `height transition duration: 0`（冻结）；`onAnimationComplete` 后 50ms 延迟，再 300ms ease-out 过渡到目标面精确高度
3. **内容 crossfade** — 前/背面改为 `motion.div`，翻转时正面立即淡出 (180ms)，背面延迟淡入 (delay 360ms + 200ms)
4. **scale 脉冲** — 翻转中缩小 3%，落定后 0.8% 微弹
5. **boxShadow 联动** — 8 帧阴影深度变化，增强 3D 纵深感
6. **光晕掠过** — `flipCountRef` 防止首次挂载触发；`flipTrigger` state 驱动 key 重新挂载动画；白色渐变光带 120% 宽度横扫
7. **will-change: transform** — GPU 合成加速
8. **移除 measure 辅助函数** — 直接内联读取 ref，消除 hook 依赖警告

### ZenToast.tsx — 居中修复
1. `absolute inset-0 z-40` → `fixed inset-0 z-9999` — 脱离 3D 上下文，始终视口居中
2. 入场动画增加 `scale: 0.92→1`，退场增加 `y: -8` 上飘 + `scale: 0.95` 缩放
3. spring 参数调优：`stiffness: 380/damping: 24`

### index.css
1. `.zen-flip-face` 添加 `will-change: transform, opacity` — GPU 合成层优化
