# 0228_10: 翻转卡片等高 + 3D 透视裁切修复

## 问题现状

**Bug A — 翻转时白色玻璃超出黑色玻璃**
从主页面（WorkArea）翻转到设置页面（SettingsPanel）时，第⑤层 `motion.div` 容器高度锁定为 `max(frontH, backH)`。如果设置面比主页面矮，GlassCard 只占自然高度，容器底部出现大片空白，`boxShadow` 框住整个 max 高度区域，形成"白色玻璃超出黑色玻璃"的视觉错位。

**Bug B — 翻转时卡片顶部被裁切**
拖拽区域（第③层）的顶部内边距仅 `pt-4`（16px），3D 透视旋转（`perspective: 1200px` + `rotateY`）时卡片顶部角点的投影向上延伸约 40px+，被 `overflow: clip` 裁掉。

**Bug C — 修复 Bug B 后底部 UI 被裁切**
将 padding 增大到 `pt-16 pb-16`（上下各 64px）后，CSS padding 总计 128px，但 `WINDOW_VERTICAL_PADDING` 仅 40px，OS 窗口高度不足以容纳内容 + padding，底部被截断。

## 底层原因分析

**Bug A 根因**：高度管理策略的副作用。翻转期间容器高度 = `max(fh, bh)` 是为了防止 3D 翻转裁切两面内容，但矮面的 GlassCard 保持自然高度，不会拉伸填满容器空间。0.72s 翻转动画中约 400-450ms 的时间里（侧面切换后到翻转完成），矮面底部有明显空白。

**Bug B 根因**：卡片宽 568px，在 `perspective: 1200px` 下 rotateY 约 45° 时，顶部角点投影比原始位置上移约 40px。原 `pt-4`（16px）padding 不可能容纳，被 `overflow: clip` 裁掉。

**Bug C 根因**：`WINDOW_VERTICAL_PADDING`（40px）≠ CSS 实际 vertical padding（128px），OS 窗口比内容+padding 需要的高度矮 88px。

## 解决方案

### 方案 B（等高策略）解决 Bug A

**思路**：翻转期间让正面和背面 face slot 显式拉伸到容器高度，GlassCard 的 flex 布局填满拉伸空间，翻转结束后恢复自然高度。

**改动**：

| 文件 | 改动 | 说明 |
|------|------|------|
| `FlipCard.tsx` 第⑥层 | face slot 添加 `height: targetHeight`（仅 `isFlipAnimating` 时） | 两面拉伸到等高 |
| `FlipCard.tsx` `handleFlipComplete` | 简化为只清除 `isFlipAnimating` 标志 | ResizeObserver 的 `useLayoutEffect` 在 paint 前同步重新测量 |
| `GlassCard.tsx` 外层 div | 添加 `flex h-full flex-col` | 当父级有显式高度时拉伸到该高度 |
| `GlassCard.tsx` 内层 main | 添加 `grow` | flex-grow 填满外层空间，消除空白 |

**原理**：face slot `height: targetHeight` → GlassCard 外层 `h-full` 拉伸 → 内层 `grow` 填满。翻转结束后 `height` 被移除，`h-full` 对 auto 高度的父级不生效，恢复内容自然高度。

### Padding 扩大解决 Bug B

| 文件 | 改动 |
|------|------|
| `FlipCard.tsx` 第③层 | `pt-4 pb-12` → `pt-16 pb-16`（上下各 64px） |

### WINDOW_VERTICAL_PADDING 对齐解决 Bug C

| 文件 | 改动 |
|------|------|
| `tokens.ts` | `WINDOW_VERTICAL_PADDING` 40 → 128（= pt-16 + pb-16 = 64 + 64） |

## 副作用清理

用户之前手动注释掉了 `motion.div` 的 `boxShadow` 动画，遗留了未使用的导入和变量：

| 文件 | 清理项 |
|------|--------|
| `FlipCard.tsx` | 移除 `FLIP_SHADOW`, `FLIP_STATIC_SHADOW`, `FLIP_SHADOW_TRANSITION` 导入 |
| `FlipCard.tsx` | 移除 `animateShadow` 变量 |

## 附加产出

创建 `devlog/WINDOW_LAYERS.md`：窗口 7 层嵌套结构文档，覆盖每层的职责、控制文件、尺寸传递链和等高策略。

## 变更文件清单

| 文件 | 改动类型 |
|------|----------|
| `src/components/layout/FlipCard.tsx` | 等高策略 + padding 修复 + 清理未用导入 |
| `src/components/shared/GlassCard.tsx` | flex + grow 拉伸 |
| `src/shared/tokens.ts` | `WINDOW_VERTICAL_PADDING` 128 |
| `devlog/WINDOW_LAYERS.md` | 新文件，窗口层级文档 |
