# 0301_01 — 自定义角色按钮文字换行闪动问题

**日期**：2026-03-01  
**状态**：Research

---

## 问题现状

用户在「自定义人物」按钮中输入文字后（如"奇葩房东"），切换到其他预设角色按钮（老板/甲方/绿茶），再切换回「自定义」时，按钮内文字有时会短暂换行，导致按钮高度增加，随即又缩回原状，产生明显的布局闪动，影响视觉美观。

---

## 底层原因分析

### 触发链

1. 自定义按钮的 `key` 为 `` `custom-role-button-${customRoleName || "empty"}` ``  
2. 当 `customRoleName` 从 `""` 变为 `"奇葩房东"`（或反之），AnimatePresence 判定为**新元素**，会销毁旧按钮并挂载新按钮
3. 新按钮挂载时，包裹它的 `<div>` **没有显式宽度**（仅 `isCustomRoleEditing` 为 true 时才通过 JS 测量设置宽度）
4. 浏览器在布局新按钮时，容器宽度尚未稳定 → 如果容器恰好比按钮文字自然宽度更窄，文字被迫换行
5. 紧接着 flex 布局重新分配空间，宽度扩展回正确值 → 文字缩回单行  

### 关键缺失

`motion.button`（自定义角色）**缺少 `whitespace-nowrap`**：预设角色按钮文字极短（"老板"、"甲方"、"绿茶"），且 key 不变（永远不触发 AnimatePresence 重挂），因此没有暴露此问题；而自定义按钮 key 随内容变化、文字长度不固定，会在布局重算瞬间发生换行。

---

## 预期改动点

### 核心改动（`src/components/zenreply/RoleComposer.tsx`）

在 `motion.button`（自定义角色按钮）的 `className` 中增加 `whitespace-nowrap`，确保无论容器宽度如何波动，按钮文字始终不换行。

同时加 `shrink-0` 到包裹 `<div>`，防止 flex 容器在极端宽度下压缩该元素。

**改动前（伪代码）**：
```tsx
<div className="max-w-full transition-[width] duration-150 ease-out" ...>
  <motion.button className={`rounded-full border text-xs transition ...`}>
```

**改动后（伪代码）**：
```tsx
<div className="max-w-full shrink-0 transition-[width] duration-150 ease-out" ...>
  <motion.button className={`whitespace-nowrap rounded-full border text-xs transition ...`}>
```

---

## 实际改动记录

**文件**：`src/components/zenreply/RoleComposer.tsx`

1. 包裹 `<div>` className 增加 `shrink-0`  
   防止 flex 容器在重挂载瞬间压缩该元素宽度

2. `motion.button`（自定义角色按钮）className 增加 `whitespace-nowrap`  
   确保按钮文字在任何容器宽度下都不换行，彻底消除高度闪动

---

## 潜在风险

- `whitespace-nowrap` 不影响输入框（`motion.input`），只加在 `motion.button` 上，无副作用
- `shrink-0` 防止极窄窗口下元素被压缩，不影响正常布局
